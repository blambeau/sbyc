#!/usr/bin/env ruby
$LOAD_PATH.unshift(File.expand_path('../../lib', __FILE__))
require 'sbyc'
require 'sbyc/shortspaces'

def read(str)
  ::SByC::R::parse(str)
end

def evaluate(ast, context = {})
  ::SByC::R::evaluate(context, ast)
end

def print(value)
  R::Alpha::domain_of(value).to_literal(value)
end

if ARGV.size == 1
  exprs = ::SByC::R::parse(File.read(ARGV[0]), :multiline => true)
  value = nil
  exprs.each{|expr|
    value = evaluate(expr)
  }
  puts print(value)
else
  require 'readline'
  stop = false
  while !stop
    str = Readline.readline("elodie# ", true)
    case str 
      when /^q(uit)?$/
        stop = true
      else
        begin
          puts print(evaluate(read(str)))
        rescue Exception => ex
          puts ex.message
          puts ex.backtrace.join("\n")
        end
    end
  end
end